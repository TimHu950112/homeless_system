{% extends "base.html" %}

{% block title %}我的餐券 - 無家者服務整合平台{% endblock %}

{% block extra_css %}
<style>
    .voucher-card {
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .voucher-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }

    .voucher-card.used {
        opacity: 0.7;
    }

    .qr-code-container {
        background: white;
        padding: 1rem;
        border-radius: 10px;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 200px;
        position: relative;
    }

    .qr-code-container img {
        max-width: 100%;
        height: auto;
        border-radius: 5px;
    }

    .voucher-ribbon {
        position: absolute;
        top: 15px;
        right: -30px;
        transform: rotate(45deg);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 5px 40px;
        font-size: 0.8rem;
        font-weight: bold;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .voucher-number {
        font-family: 'Courier New', monospace;
        font-size: 1.2rem;
        font-weight: bold;
        color: #667eea;
    }
</style>
{% endblock %}

{% block content %}
<div class="text-center mb-5" data-aos="fade-down">
    <h1 class="display-4 gradient-text mb-3">
        <i class="bi bi-ticket-perforated me-2"></i>我的餐券
    </h1>
    <p class="lead text-muted">出示 QR Code 即可在合作餐廳使用</p>
</div>

{% if vouchers %}
<div class="row g-4">
    {% for voucher in vouchers %}
    <div class="col-lg-4 col-md-6" data-aos="fade-up" data-aos-delay="{{ loop.index0 * 50 }}">
        <div class="card voucher-card h-100 {% if voucher.get('is_used') %}used{% endif %}">
            <!-- Ribbon for unused vouchers -->
            {% if not voucher.get('is_used') %}
            <div class="voucher-ribbon">可使用</div>
            {% endif %}

            <div class="card-header {% if voucher.get('is_used') %}bg-secondary text-white{% else %}bg-gradient-primary text-white{% endif %} text-center py-3">
                <h5 class="mb-1">
                    {% if voucher.get('is_used') %}
                    <i class="bi bi-check-circle-fill me-2"></i>已使用
                    {% else %}
                    <i class="bi bi-ticket-perforated-fill me-2"></i>未使用
                    {% endif %}
                </h5>
                <p class="mb-0 voucher-number">#{{ '%05d' % voucher.get('id') }}</p>
            </div>

            <div class="card-body">
                <!-- QR Code for unused vouchers -->
                {% if not voucher.get('is_used') and voucher.get('qr_code') %}
                <div class="qr-code-container mb-3 shadow-sm">
                    <img src="data:image/png;base64,{{ voucher.get('qr_code') }}"
                         alt="QR Code"
                         class="pulse">
                </div>
                <div class="alert alert-info py-2 mb-3">
                    <small>
                        <i class="bi bi-qr-code me-1"></i>
                        請向餐廳人員出示此 QR Code
                    </small>
                </div>
                {% endif %}

                <!-- Voucher Details -->
                <div class="mb-2">
                    <i class="bi bi-tag-fill text-primary me-2"></i>
                    <strong>餐點類型：</strong>
                    <span class="badge bg-primary">{{ voucher.get('meal_type', '一般餐') }}</span>
                </div>

                <div class="mb-2">
                    <i class="bi bi-calendar-event text-success me-2"></i>
                    <strong>發放日期：</strong>
                    {{ voucher.get('issued_date', '')[:10] if voucher.get('issued_date') else '未知' }}
                </div>

                <div class="mb-2">
                    <i class="bi bi-calendar-x text-warning me-2"></i>
                    <strong>有效期限：</strong>
                    {{ voucher.get('expiry_date', '')[:10] if voucher.get('expiry_date') else '未知' }}
                </div>

                {% if voucher.get('is_used') %}
                <hr>
                <div class="mb-2">
                    <i class="bi bi-clock-history text-secondary me-2"></i>
                    <strong>使用日期：</strong>
                    {{ voucher.get('used_date', '')[:10] if voucher.get('used_date') else '未知' }}
                </div>
                <div class="mb-0">
                    <i class="bi bi-shop text-secondary me-2"></i>
                    <strong>使用地點：</strong>
                    {{ voucher.get('provider_name', '未記錄') }}
                </div>
                {% endif %}
            </div>

            {% if not voucher.get('is_used') %}
            <div class="card-footer bg-light text-center">
                <a href="{{ url_for('food.voucher_qrcode', voucher_id=voucher.get('id')) }}"
                   class="btn btn-sm btn-outline-primary"
                   target="_blank">
                    <i class="bi bi-download me-1"></i>下載 QR Code
                </a>
            </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- Summary Info -->
<div class="row mt-5">
    <div class="col-md-6" data-aos="fade-right">
        <div class="card shadow-sm">
            <div class="card-body text-center">
                <i class="bi bi-ticket-perforated text-success" style="font-size: 3rem;"></i>
                <h3 class="mt-3 mb-0">{{ vouchers|selectattr('is_used', 'equalto', False)|list|length }}</h3>
                <p class="text-muted mb-0">可用餐券</p>
            </div>
        </div>
    </div>
    <div class="col-md-6" data-aos="fade-left">
        <div class="card shadow-sm">
            <div class="card-body text-center">
                <i class="bi bi-check-circle text-secondary" style="font-size: 3rem;"></i>
                <h3 class="mt-3 mb-0">{{ vouchers|selectattr('is_used', 'equalto', True)|list|length }}</h3>
                <p class="text-muted mb-0">已使用</p>
            </div>
        </div>
    </div>
</div>

{% else %}
<div class="alert alert-info shadow-sm" data-aos="zoom-in">
    <div class="d-flex align-items-center">
        <i class="bi bi-info-circle me-3" style="font-size: 2rem;"></i>
        <div>
            <h5 class="mb-1">您目前沒有餐券</h5>
            <p class="mb-0">
                <a href="{{ url_for('food.index') }}" class="alert-link">
                    前往餐食服務 <i class="bi bi-arrow-right"></i>
                </a>
            </p>
        </div>
    </div>
</div>
{% endif %}

<div class="mt-5 d-flex gap-3 justify-content-center" data-aos="fade-up">
    <a href="{{ url_for('food.index') }}" class="btn btn-primary btn-lg">
        <i class="bi bi-arrow-left me-2"></i> 返回餐食服務
    </a>
    {% if current_user.user_type in ['social_worker', 'admin'] %}
    <a href="{{ url_for('food.verify_voucher') }}" class="btn btn-success btn-lg">
        <i class="bi bi-qr-code-scan me-2"></i> 驗證餐券
    </a>
    {% endif %}
</div>

<!-- Info Section -->
<div class="alert alert-warning mt-5 shadow-sm" data-aos="zoom-in">
    <div class="d-flex align-items-start">
        <div class="me-3" style="font-size: 2rem;">
            <i class="bi bi-lightbulb text-warning"></i>
        </div>
        <div>
            <h5 class="mb-3">
                <i class="bi bi-info-circle me-2"></i>使用說明
            </h5>
            <ul class="mb-0">
                <li class="mb-2"><i class="bi bi-check-circle text-success me-2"></i>請在有效期限內使用餐券</li>
                <li class="mb-2"><i class="bi bi-check-circle text-success me-2"></i>每張餐券僅限使用一次</li>
                <li class="mb-2"><i class="bi bi-check-circle text-success me-2"></i>請至合作餐廳出示 QR Code</li>
                <li class="mb-0"><i class="bi bi-check-circle text-success me-2"></i>遺失或過期餐券無法補發</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}
